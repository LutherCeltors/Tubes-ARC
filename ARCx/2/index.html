<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IDR di Dunia</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Pindahkan Chart.js ke head -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="top">
      <h1>Nilai IDR di Dunia</h1>
      <h4>Powered by Alpha Vantage</h4>
    </div>
    <div class="bottom"></div>
    <div class="center">
      <header class="header">
        <a href="index2.html">Konversi</a>
        <a href="#" class="active">Bagan historis</a>
      </header>
      <nav class="container">
        <div class="conv">
          <div class="currency-button">
            <div class="currency-content">
              USD
              <img
                src="https://upload.wikimedia.org/wikipedia/en/a/a4/Flag_of_the_United_States.svg"
                alt="USA Flag"
              />
            </div>
            <button class="currencychoice">
              <i class="fas fa-arrow-down"></i>
            </button>
          </div>
          <div class="keRupiah">ke Rupiah</div>
        </div>
        <div class="period">
          <button>7H</button>
          <button class="active">30H</button>
          <button>90H</button>
          <button>1T</button>
        </div>
      </nav>
      <div class="graph">
        <div class="chart-container">
          <canvas id="currencyChart"></canvas>
        </div>
      </div>
      <div class="currency-dropdown" style="display: none">
        <div class="dropdown-content">
          <div class="search-box">
            <input
              type="text"
              placeholder="Cari mata uang..."
              id="currencySearch"
            />
          </div>
          <div class="currency-list">
            <!-- Popular currencies -->
            <div class="currency-option" data-currency="USD">
              <img
                src="https://upload.wikimedia.org/wikipedia/en/a/a4/Flag_of_the_United_States.svg"
                alt="USA Flag"
              />
              <span>USD - Dolar Amerika</span>
            </div>
            <div class="currency-option" data-currency="EUR">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/b/b7/Flag_of_Europe.svg"
                alt="EU Flag"
              />
              <span>EUR - Euro</span>
            </div>
            <div class="currency-option" data-currency="GBP">
              <img
                src="https://upload.wikimedia.org/wikipedia/en/a/ae/Flag_of_the_United_Kingdom.svg"
                alt="UK Flag"
              />
              <span>GBP - Pound Sterling</span>
            </div>
            <div class="currency-option" data-currency="JPY">
              <img
                src="https://upload.wikimedia.org/wikipedia/en/9/9e/Flag_of_Japan.svg"
                alt="Japan Flag"
              />
              <span>JPY - Yen Jepang</span>
            </div>
            <div class="currency-option" data-currency="SGD">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/4/48/Flag_of_Singapore.svg"
                alt="Singapore Flag"
              />
              <span>SGD - Dolar Singapura</span>
            </div>
            <div class="currency-option" data-currency="AUD">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/8/88/Flag_of_Australia_%28converted%29.svg"
                alt="Australia Flag"
              />
              <span>AUD - Dolar Australia</span>
            </div>
            <div class="currency-option" data-currency="CNY">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Flag_of_the_People%27s_Republic_of_China.svg"
                alt="China Flag"
              />
              <span>CNY - Yuan China</span>
            </div>
            <div class="currency-option" data-currency="MYR">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/6/66/Flag_of_Malaysia.svg"
                alt="Malaysia Flag"
              />
              <span>MYR - Ringgit Malaysia</span>
            </div>
          </div>
        </div>
      </div>

      <style>
        .chart-container {
          width: 750px;
          height: 400px;
          margin-top: 20px;
        }

        .currency-dropdown {
          position: absolute;
          background-color: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          z-index: 100;
          width: 250px;
          max-height: 300px;
          overflow-y: auto;
        }

        .dropdown-content {
          padding: 10px;
        }

        .search-box {
          margin-bottom: 10px;
        }

        .search-box input {
          width: 100%;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
        }

        .currency-option {
          display: flex;
          align-items: center;
          padding: 8px;
          cursor: pointer;
          border-radius: 4px;
        }

        .currency-option:hover {
          background-color: #f0f0f0;
        }

        .currency-option img {
          width: 20px;
          height: 15px;
          margin-right: 10px;
        }

        .period button {
          padding: 5px 10px;
          margin: 0 5px;
          border: 1px solid #ddd;
          border-radius: 4px;
          background-color: white;
          cursor: pointer;
        }

        .period button:hover {
          background-color: #f0f0f0;
        }

        .period button.active {
          background-color: #18a5eb;
          color: white;
          border-color: #18a5eb;
        }
      </style>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          // API key and initial setup
          const apiKey = "BKHNJ42C53BDCELX";
          let currentCurrency = "USD";
          let currentPeriod = "30H";
          let currencyChart = null;

          // DOM elements
          const currencyButton = document.querySelector(".currency-button");
          const currencyChoice = document.querySelector(".currencychoice");
          const currencyDropdown = document.querySelector(".currency-dropdown");
          const currencySearch = document.getElementById("currencySearch");
          const currencyOptions = document.querySelectorAll(".currency-option");
          const periodButtons = document.querySelectorAll(".period button");

          // Initialize the chart
          function initChart() {
            const ctx = document.getElementById("currencyChart");
            if (!ctx) {
              console.error("Canvas element not found!");
              return;
            }

            currencyChart = new Chart(ctx.getContext("2d"), {
              type: "line",
              data: {
                labels: [],
                datasets: [
                  {
                    label: `Nilai ${currentCurrency} ke IDR`,
                    data: [],
                    borderColor: "rgb(75, 192, 192)",
                    backgroundColor: "rgba(75, 192, 192, 0.2)",
                    tension: 0.1,
                    fill: false,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: false,
                    title: {
                      display: true,
                      text: "Nilai IDR",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "Tanggal/Waktu",
                    },
                  },
                },
              },
            });

            fetchCurrencyData(currentCurrency, currentPeriod);
          }

          // Fetch currency data from Alpha Vantage
          async function fetchCurrencyData(currency, period) {
            try {
              console.log(`Fetching data for ${currency} period ${period}`);

              if (currencyChart) {
                currencyChart.data.datasets[0].data = [];
                currencyChart.data.labels = [];
                currencyChart.update();
              }

              let functionName, outputSize;
              switch (period) {
                case "7H":
                  functionName = "FX_INTRADAY";
                  outputSize = "compact";
                  break;
                case "30H":
                  functionName = "FX_DAILY";
                  outputSize = "compact";
                  break;
                case "90H":
                  functionName = "FX_DAILY";
                  outputSize = "full";
                  break;
                case "1T":
                  functionName = "FX_MONTHLY";
                  outputSize = "compact";
                  break;
                default:
                  functionName = "FX_DAILY";
                  outputSize = "compact";
              }

              let url = `https://www.alphavantage.co/query?function=${functionName}&from_symbol=${currency}&to_symbol=IDR&apikey=${apiKey}`;

              if (functionName === "FX_INTRADAY") {
                url += "&interval=60min";
              }

              if (outputSize) {
                url += `&outputsize=${outputSize}`;
              }

              console.log("Fetching URL:", url);
              const response = await fetch(url);
              const data = await response.json();
              console.log("API Response:", data);

              let timeSeries;
              if (functionName === "FX_INTRADAY") {
                timeSeries = data["Time Series FX (60min)"];
              } else if (functionName === "FX_DAILY") {
                timeSeries = data["Time Series FX (Daily)"];
              } else if (functionName === "FX_MONTHLY") {
                timeSeries = data["Time Series FX (Monthly)"];
              }

              if (!timeSeries) {
                console.error("Invalid data structure:", data);
                alert(
                  "Gagal memuat data. Silakan coba lagi nanti atau periksa konsol untuk detailnya."
                );
                return;
              }

              const dates = Object.keys(timeSeries).sort();
              const closePrices = dates.map((date) =>
                parseFloat(timeSeries[date]["4. close"])
              );

              let displayDates, displayPrices;
              if (period === "7H") {
                displayDates = dates.slice(-7);
                displayPrices = closePrices.slice(-7);
              } else if (period === "30H") {
                displayDates = dates.slice(-30);
                displayPrices = closePrices.slice(-30);
              } else if (period === "90H") {
                displayDates = dates.slice(-90);
                displayPrices = closePrices.slice(-90);
              } else {
                displayDates = dates;
                displayPrices = closePrices;
              }

              const formattedDates = displayDates.map((date) => {
                if (functionName === "FX_INTRADAY") {
                  return new Date(date).toLocaleTimeString();
                } else if (functionName === "FX_MONTHLY") {
                  return new Date(date).toLocaleDateString("id-ID", {
                    month: "short",
                    year: "numeric",
                  });
                } else {
                  return new Date(date).toLocaleDateString("id-ID");
                }
              });

              if (currencyChart) {
                currencyChart.data.labels = formattedDates;
                currencyChart.data.datasets[0].data = displayPrices;
                currencyChart.data.datasets[0].label = `Nilai ${currency} ke IDR`;
                currencyChart.update();
              }
            } catch (error) {
              console.error("Error fetching currency data:", error);
              alert(
                "Terjadi kesalahan saat memuat data. Silakan coba lagi nanti."
              );
            }
          }

          // Event listeners
          currencyChoice.addEventListener("click", (e) => {
            e.stopPropagation();
            currencyDropdown.style.display =
              currencyDropdown.style.display === "none" ? "block" : "none";
          });

          currencyOptions.forEach((option) => {
            option.addEventListener("click", () => {
              const currency = option.getAttribute("data-currency");
              currentCurrency = currency;

              const currencyContent =
                document.querySelector(".currency-content");
              currencyContent.innerHTML = `
                ${currency}
                <img src="${
                  option.querySelector("img").src
                }" alt="${currency} Flag">
              `;

              currencyDropdown.style.display = "none";
              fetchCurrencyData(currentCurrency, currentPeriod);
            });
          });

          currencySearch.addEventListener("input", () => {
            const searchTerm = currencySearch.value.toLowerCase();
            currencyOptions.forEach((option) => {
              const text = option.textContent.toLowerCase();
              option.style.display = text.includes(searchTerm)
                ? "flex"
                : "none";
            });
          });

          periodButtons.forEach((button) => {
            button.addEventListener("click", () => {
              periodButtons.forEach((btn) => btn.classList.remove("active"));
              button.classList.add("active");
              currentPeriod = button.textContent;
              fetchCurrencyData(currentCurrency, currentPeriod);
            });
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (event) => {
            if (!currencyButton.contains(event.target)) {
              currencyDropdown.style.display = "none";
            }
          });

          // Initialize the chart
          initChart();
        });
      </script>
    </div>
  </body>
</html>
